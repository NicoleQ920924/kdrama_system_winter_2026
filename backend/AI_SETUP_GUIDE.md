# Spring AI Integration Guide
Generated by GitHub Copilot

This document explains the Spring AI, pgvector, and Gemini integration in the kdrama_system project.

## Overview

The project now includes:
- **Spring AI**: Framework for building AI-powered applications
- **Google Gemini**: LLM integration for natural language processing
- **PostgreSQL with pgvector**: Vector database for semantic search and embeddings

## Components Added

### 1. Dependencies (pom.xml)

- `spring-ai-starter-model-google-genai`: Gemini LLM integration
- `spring-ai-pgvector-store-spring-boot-starter`: Vector store support
- `spring-ai-pdf-document-reader`: Document processing capabilities
- `postgresql`: PostgreSQL JDBC driver
- `pgvector`: pgvector Java library for vector operations

### 2. Configuration

#### Environment Variables Required

```bash
# Google Gemini API Configuration
GOOGLE_API_KEY=your-api-key-here
GOOGLE_PROJECT_ID=your-project-id-here

# PostgreSQL for Vector Store
# Configure in application.properties or environment
```

#### application.properties

New properties added:
```properties
# Gemini Configuration
spring.ai.google.ai.gemini.api-key=${GOOGLE_API_KEY}
spring.ai.google.ai.gemini.project-id=${GOOGLE_PROJECT_ID}
spring.ai.google.ai.gemini.model=gemini-2.5-flash-lite

# PostgreSQL Vector Store (pgvector)
spring.ai.vectorstore.pgvector.db-name=kdrama_embeddings
spring.ai.vectorstore.pgvector.host=localhost
spring.ai.vectorstore.pgvector.port=5432
spring.ai.vectorstore.pgvector.user={username}
spring.ai.vectorstore.pgvector.password={password}
spring.ai.vectorstore.pgvector.init-mode=always
spring.ai.vectorstore.pgvector.enabled=true
```

### 3. New Classes

#### AiService
Located in: `src/main/java/com/kdrama/backend/service/AiService.java`

Provides core AI functionality:
- `generateResponse(prompt)`: Generate text responses using Gemini
- `generateResponseWithTemplate(template, params)`: Template-based generation
- `generateDramaRecommendations(preferences)`: AI-powered drama recommendations
- `summarizeDramaInfo(description)`: Summarize drama information
- `addDocuments(documents)`: Add documents to vector store
- `searchSimilarDocuments(query, k)`: Semantic search

#### AiController
Located in: `src/main/java/com/kdrama/backend/controller/AiController.java`

REST endpoints for AI functionality:
- `POST /api/ai/generate`: General text generation
- `POST /api/ai/drama/recommendations`: Get drama recommendations
- `POST /api/ai/drama/summarize`: Summarize drama info
- `GET /api/ai/search`: Search vector store
- `POST /api/ai/documents/add`: Add documents to vector store

#### AiConfiguration
Located in: `src/main/java/com/kdrama/backend/config/AiConfiguration.java`

Spring configuration for pgvector and embeddings setup.

## Setup Instructions

### 1. Get Google Gemini API Key

1. Go to [Google AI Studio](https://aistudio.google.com/api-keys)
2. Create a new API key
3. Set environment variable: `GOOGLE_API_KEY`

### 2. Setup PostgreSQL with pgvector

```bash
# Install PostgreSQL (if not already installed)
# macOS
brew install postgresql

# Linux (Ubuntu/Debian)
sudo apt-get install postgresql postgresql-contrib

# Windows
# Download from https://www.postgresql.org/download/windows/
```

Create vector store database:
```sql
-- Connect to PostgreSQL
psql -U postgres

-- Create database
CREATE DATABASE kdrama_embeddings;

-- Connect to new database
\c kdrama_embeddings

-- Enable pgvector extension
CREATE EXTENSION IF NOT EXISTS vector;

-- Verify extension
SELECT * FROM pg_extension;
```

### 3. Set Environment Variables

Windows (PowerShell):
```powershell
$env:GOOGLE_API_KEY="your-api-key-here"
$env:GOOGLE_PROJECT_ID="your-project-id-here"
```

Windows (Command Prompt):
```cmd
set GOOGLE_API_KEY=your-api-key-here
set GOOGLE_PROJECT_ID=your-project-id-here
```

Linux/macOS:
```bash
export GOOGLE_API_KEY="your-api-key-here"
export GOOGLE_PROJECT_ID="your-project-id-here"
```

### 4. Build and Run

```bash
cd backend
./mvnw clean install
./mvnw spring-boot:run
```

## API Usage Examples

### 1. Generate Recommendation

```bash
curl -X POST http://localhost:8080/api/ai/drama/recommendations \
  -H "Content-Type: application/json" \
  -d '{
    "preferences": "I like historical K-dramas with strong female characters and romance elements"
  }'
```

Response:
```json
{
  "recommendations": "1. Mr. Sunshine - A gripping historical drama...\n2. Descendants of the Sun - Action-packed romance..."
}
```

### 2. Summarize Drama Info

```bash
curl -X POST http://localhost:8080/api/ai/drama/summarize \
  -H "Content-Type: application/json" \
  -d '{
    "description": "Descendants of the Sun follows two soldiers from different countries who meet while serving in a war-torn country..."
  }'
```

### 3. General Text Generation

```bash
curl -X POST http://localhost:8080/api/ai/generate \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "Explain the popularity of K-dramas in 2-3 sentences"
  }'
```

### 4. Vector Search

```bash
curl "http://localhost:8080/api/ai/search?query=romantic%20historical%20drama&k=5"
```

## Troubleshooting

### Issue: "Connection refused" for PostgreSQL
- Ensure PostgreSQL is running: `brew services start postgresql` (macOS)
- Check credentials in `application.properties`
- Verify database exists and pgvector extension is enabled

### Issue: Gemini API Key not found
- Ensure environment variable is set correctly
- Restart the application after setting environment variable
- Check that variable name matches: `GOOGLE_GEMINI_API_KEY`

### Issue: "pgvector not available"
- Verify pgvector extension is installed in PostgreSQL
- Check PostgreSQL version (pgvector requires PostgreSQL 11+)
- Re-run: `CREATE EXTENSION IF NOT EXISTS vector;`

## Next Steps

1. **Integrate AI into existing services**: Modify DramaService, ActorService, MovieService to use AiService
2. **Implement caching**: Add caching for AI responses to reduce API calls
3. **Fine-tune embeddings**: Train custom embeddings on your kdrama dataset
4. **Add rate limiting**: Implement rate limiting for AI API calls
5. **Error handling**: Add comprehensive error handling and logging

## Resources

- [Spring AI Documentation](https://docs.spring.io/spring-ai/reference/)
- [Google Gemini API](https://ai.google.dev/docs)
- [pgvector Documentation](https://github.com/pgvector/pgvector)
- [PostgreSQL Setup Guide](https://www.postgresql.org/docs/current/server-start.html)

## Notes

- Spring AI is currently in SNAPSHOT version, so dependencies are pulled from Spring's snapshot repository
- Ensure your Java version (25) is compatible with Spring Boot 3.5.10 and Spring AI
- Vector store initialization is set to "always" which recreates tables on startup - change to "validate" for production
